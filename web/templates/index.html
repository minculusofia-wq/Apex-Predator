<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ HFT Scalper Bot - Polymarket</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-red);
            margin-right: 0.5rem;
            display: inline-block;
        }

        .status-dot.active {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
        }

        /* Config Dirty Indicator */
        .btn-config-dirty {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            border-color: #d97706 !important;
            animation: pulse-warning 1.5s ease-in-out infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 15px 3px rgba(245, 158, 11, 0.3); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            animation: toast-in 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .toast-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        @keyframes toast-in {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes toast-out {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }

        /* Binance Ticker */
        .ticker-wrap {
            width: 100%;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
            height: 30px;
            display: flex;
            align-items: center;
        }

        .ticker {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: ticker 30s linear infinite;
        }

        .ticker-item {
            display: inline-block;
            padding: 0 1.5rem;
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
        }

        @keyframes ticker {
            0% {
                transform: translate3d(0, 0, 0);
            }

            100% {
                transform: translate3d(-100%, 0, 0);
            }
        }

        /* Layout */
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            grid-template-rows: 250px 1fr;
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 80px);
        }

        .sidebar {
            grid-column: 1;
            grid-row: 1 / 3; /* Span both rows */
            overflow-y: auto;
        }

        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            text-align: center;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        /* Inputs */
        .config-group {
            margin-bottom: 0.75rem;
        }

        .config-group label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .config-group input {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .config-group input:focus {
            border-color: var(--accent-blue);
            outline: none;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Tables */
        .table-container {
            overflow: auto;
            height: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            text-align: left;
            position: sticky;
            top: 0;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            z-index: 10;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        .market-col {
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .value-col {
            font-family: 'JetBrains Mono', monospace;
        }

        .profit-pos {
            color: var(--accent-green);
        }

        .profit-neg {
            color: var(--accent-red);
        }

        .trade-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .trade-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-primary);
        }

        .trade-btn.yes:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .trade-btn.no:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .active-trades-panel {
            grid-column: 2;
            grid-row: 1;
            height: 250px;
        }

        .opportunities-panel {
            grid-column: 2;
            grid-row: 2;
            min-height: 300px;
            overflow-y: auto;
        }

        .log-panel {
            height: 150px;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .log-entry {
            margin-bottom: 2px;
        }
    </style>
</head>

<body>
    <!-- Toast Container for Notifications -->
    <div class="toast-container" id="toast-container"></div>

    <header class="header">
        <div class="logo">
            <span>üöÄ</span>
            <h1>HFT SCALPER</h1>
        </div>
        <div class="status-bar">
            <div><span class="status-dot" id="status-dot"></span><span id="status-text">Arr√™t√©</span></div>
            <div>üìä <span id="markets-count">0</span> Mkts</div>
            <div>‚è±Ô∏è <span id="uptime">00:00:00</span></div>
        </div>
    </header>

    <div class="ticker-wrap">
        <div class="ticker" id="binance-ticker">
            <!-- Ticker items will be injected here -->
            <span class="ticker-item">Chargement Binance Market Data...</span>
        </div>
    </div>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Stats -->
            <div class="panel" style="margin-bottom: 1rem;">
                <div class="panel-header">üìä Performance Jour</div>
                <div class="panel-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">P&L</div>
                            <div class="stat-value" id="stat-pnl">$0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-value" id="stat-winrate">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Trades</div>
                            <div class="stat-value" id="stat-trades">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Open</div>
                            <div class="stat-value" id="stat-positions">0/5</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strategy Mode Selector (v7.0) -->
            <div class="panel" style="margin-bottom: 1rem;">
                <div class="panel-header">üéØ Mode Strat√©gie</div>
                <div class="panel-content">
                    <select id="strategy-mode" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer;">
                        <option value="gabagool">ü¶Ä Gabagool seul</option>
                        <option value="smart_ape">ü¶ç Smart Ape seul</option>
                        <option value="both">üî• Les deux strat√©gies</option>
                    </select>
                    <div style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-secondary);">
                        <div id="strategy-desc">Arbitrage YES+NO &lt; $1.00</div>
                    </div>
                </div>
            </div>

            <!-- Capital Management (v7.1) -->
            <div class="panel" style="margin-bottom: 1rem;">
                <div class="panel-header">üí∞ Gestion Capital</div>
                <div class="panel-content">
                    <!-- Gabagool Capital -->
                    <div style="margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--accent-green); margin-bottom: 0.5rem;">ü¶Ä Gabagool</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div class="config-group" style="margin-bottom: 0;">
                                <label>Capital ($)</label>
                                <input type="number" id="gabagool-capital" step="50" value="500" min="50">
                            </div>
                            <div class="config-group" style="margin-bottom: 0;">
                                <label>% par Trade</label>
                                <input type="number" id="gabagool-percent" step="1" value="5" min="1" max="25">
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Trade: <span id="gabagool-trade-size" class="mono" style="color: var(--accent-blue);">$25.00</span>
                        </div>
                    </div>

                    <!-- Smart Ape Capital -->
                    <div>
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--accent-purple); margin-bottom: 0.5rem;">ü¶ç Smart Ape</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div class="config-group" style="margin-bottom: 0;">
                                <label>Capital ($)</label>
                                <input type="number" id="smart-ape-capital" step="50" value="300" min="50">
                            </div>
                            <div class="config-group" style="margin-bottom: 0;">
                                <label>% par Trade</label>
                                <input type="number" id="smart-ape-percent" step="1" value="8" min="1" max="25">
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Trade: <span id="smart-ape-trade-size" class="mono" style="color: var(--accent-blue);">$24.00</span>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-sm" onclick="saveCapitalConfig()" style="width: 100%; justify-content: center; margin-top: 0.75rem;">üíæ Sauvegarder Capital</button>
                </div>
            </div>

            <!-- Kelly Sizing (v7.2) -->
            <div class="panel" style="margin-bottom: 1rem;">
                <div class="panel-header">üìä Kelly Sizing</div>
                <div class="panel-content">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                        Dimensionnement optimal bas√© sur l'edge statistique
                    </div>

                    <!-- Per-strategy toggles -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 4px;">
                        <label style="margin:0; font-size: 0.8rem; color: var(--accent-green);">ü¶Ä Gabagool</label>
                        <input type="checkbox" id="kelly-gabagool" onchange="saveKellyConfig()">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 4px;">
                        <label style="margin:0; font-size: 0.8rem; color: var(--accent-purple);">ü¶ç Smart Ape</label>
                        <input type="checkbox" id="kelly-smart-ape" onchange="saveKellyConfig()">
                    </div>

                    <!-- Kelly parameters -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div class="config-group" style="margin-bottom: 0;">
                            <label>Fraction</label>
                            <select id="kelly-fraction" onchange="saveKellyConfig()" style="width: 100%; padding: 0.4rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                                <option value="0.125">1/8 Kelly</option>
                                <option value="0.25" selected>1/4 Kelly</option>
                                <option value="0.5">1/2 Kelly</option>
                                <option value="1.0">Full Kelly</option>
                            </select>
                        </div>
                        <div class="config-group" style="margin-bottom: 0;">
                            <label>Max Multi</label>
                            <input type="number" id="kelly-max-multi" step="0.5" value="2.0" min="1" max="5" onchange="saveKellyConfig()">
                        </div>
                    </div>

                    <!-- Kelly stats display -->
                    <div style="font-size: 0.75rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary);">Win Rate Gabagool</span>
                            <span id="kelly-winrate-gabagool" class="mono">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary);">Win Rate Smart Ape</span>
                            <span id="kelly-winrate-smartape" class="mono">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Trades analys√©s</span>
                            <span id="kelly-trades" class="mono">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config -->
            <div class="panel" style="margin-bottom: 1rem;">
                <div class="panel-header">‚öôÔ∏è Param√®tres HFT</div>
                <div class="panel-content">
                    <div class="config-group">
                        <label>Spread Min ($)</label>
                        <input type="number" id="cfg-spread" step="0.01" value="0.06">
                    </div>
                    <div class="config-group">
                        <label>Volume Min ($)</label>
                        <input type="number" id="cfg-volume" step="1000" value="20000">
                    </div>
                    <div class="config-group">
                        <label>Dur√©e Max (h)</label>
                        <input type="number" id="cfg-duration" step="1" value="24">
                    </div>
                    <div class="config-group">
                        <label>Taille Trade ($)</label>
                        <input type="number" id="cfg-capital" step="10" value="50">
                    </div>

                    <div style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <label style="margin:0; font-weight:600; font-size: 0.8rem; color: var(--accent-green);">ü§ñ
                                Auto Trading</label>
                            <input type="checkbox" id="cfg-auto-trading" checked>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <label style="margin:0; font-weight:600; font-size: 0.8rem; color: var(--accent-purple);">üß†
                                Kelly Sizing</label>
                            <input type="checkbox" id="cfg-kelly-enable">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div class="config-group">
                                <label>Min ($)</label>
                                <input type="number" id="cfg-kelly-min" step="1" value="5">
                            </div>
                            <div class="config-group">
                                <label>Max ($)</label>
                                <input type="number" id="cfg-kelly-max" step="5" value="50">
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="btn-apply-config" onclick="saveConfig()"
                        style="width: 100%; justify-content: center; margin-top: 0.5rem;">üíæ Appliquer</button>

                    <div class="btn-group" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-success" id="btn-start" onclick="startBot()"
                            style="flex: 1; justify-content: center;">‚ñ∂ Start</button>
                        <button class="btn btn-danger" id="btn-stop" onclick="stopBot()"
                            style="flex: 1; justify-content: center;" disabled>‚èπ Stop</button>
                    </div>
                </div>
            </div>

            <!-- Paper Trading Panel (v8.2) -->
            <div class="panel" style="margin-bottom: 1rem;" id="paper-panel">
                <div class="panel-header" style="background: linear-gradient(135deg, #92400e, #78350f);">
                    üìù Paper Trading
                    <span id="paper-status-badge" style="font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: #dc2626; color: white;">OFF</span>
                </div>
                <div class="panel-content">
                    <!-- Toggle ON/OFF -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">
                        <span style="font-weight: 600; color: #f59e0b;">Mode Paper</span>
                        <button class="btn btn-sm" id="btn-paper-toggle" onclick="togglePaperMode()" style="min-width: 60px;">
                            OFF
                        </button>
                    </div>

                    <!-- Capital Config -->
                    <div class="config-group">
                        <label>üí∞ Capital ($)</label>
                        <input type="number" id="paper-capital" step="100" value="500" min="50" max="100000">
                    </div>

                    <!-- Strategy Mode -->
                    <div class="config-group">
                        <label>üìä Mode Strat√©gie</label>
                        <select id="paper-strategy-mode" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                            <option value="both">Both (Gabagool + Smart Ape)</option>
                            <option value="gabagool">Gabagool Only</option>
                            <option value="smart_ape">Smart Ape Only</option>
                        </select>
                    </div>

                    <!-- Optimized Params Preview -->
                    <div id="paper-optimized-preview" style="font-size: 0.75rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 4px; margin: 0.5rem 0; display: none;">
                        <div style="color: #f59e0b; font-weight: 600; margin-bottom: 0.25rem;" id="paper-tier">TIER: --</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <div style="color: #06b6d4; font-weight: 500;">Gabagool</div>
                                <div style="color: var(--text-secondary);">Trade: <span id="paper-gab-trade" class="mono">$--</span></div>
                                <div style="color: var(--text-secondary);">Max Pos: <span id="paper-gab-pos" class="mono">--</span></div>
                            </div>
                            <div>
                                <div style="color: #a855f7; font-weight: 500;">Smart Ape</div>
                                <div style="color: var(--text-secondary);">Trade: <span id="paper-ape-trade" class="mono">$--</span></div>
                                <div style="color: var(--text-secondary);">Max Pos: <span id="paper-ape-pos" class="mono">--</span></div>
                            </div>
                        </div>
                        <div style="color: #ef4444; margin-top: 0.25rem;">Daily Limit: <span id="paper-daily-limit" class="mono">$--</span></div>
                    </div>

                    <!-- Stats -->
                    <div style="font-size: 0.75rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary);">Balance</span>
                            <span id="paper-balance" class="mono" style="color: var(--accent-green);">$500.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary);">P&L</span>
                            <span id="paper-pnl" class="mono">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Trades</span>
                            <span id="paper-trades-count" class="mono">0</span>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="btn-group" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="applyPaperConfig()" style="flex: 1; justify-content: center;">üíæ Appliquer</button>
                        <button class="btn btn-danger btn-sm" onclick="resetPaperTrading()" style="flex: 1; justify-content: center;">üîÑ Reset</button>
                    </div>
                </div>
            </div>

            <!-- Auto-Optimizer -->
            <div class="panel" style="margin-bottom: 1rem;">
                <div class="panel-header">
                    üß† Auto-Optimizer
                    <span id="optimizer-status" style="font-size: 0.75rem; opacity: 0.7;">OFF</span>
                </div>
                <div class="panel-content">
                    <div class="config-group">
                        <label>Mode</label>
                        <select id="optimizer-mode"
                            style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                            <option value="manual">Manuel</option>
                            <option value="semi_auto">Semi-Auto</option>
                            <option value="full_auto" selected>Full-Auto</option>
                        </select>
                    </div>

                    <div style="font-size: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary);">max_pair_cost</span>
                            <span id="opt-max-pair-cost" class="mono">0.98</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary);">max_pair_cost</span>
                            <span id="opt-max-pair-cost" class="mono">0.98</span>
                        </div>
                        <!-- Order Size Removed (User Controlled) -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary);">first_buy</span>
                            <span id="opt-first-buy" class="mono">0.55</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">adjustments</span>
                            <span id="opt-adjustments" class="mono" style="color: var(--accent-purple);">0</span>
                        </div>
                    </div>

                    <div
                        style="font-size: 0.7rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 4px; margin-bottom: 0.75rem;">
                        <div style="color: var(--text-secondary); margin-bottom: 0.25rem;">Conditions:</div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Spread</span>
                            <span id="opt-cond-spread" class="mono">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Volatilit√©</span>
                            <span id="opt-cond-vol" class="mono">-</span>
                        </div>
                    </div>

                    <div class="btn-group" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" id="btn-optimizer-start" onclick="startOptimizer()"
                            style="flex: 1; justify-content: center;">‚ñ∂ Start</button>
                        <button class="btn btn-danger btn-sm" id="btn-optimizer-stop" onclick="stopOptimizer()"
                            style="flex: 1; justify-content: center;" disabled>‚èπ Stop</button>
                    </div>
                </div>
            </div>

            <!-- Smart Ape Panel (v7.0) -->
            <div class="panel" id="smart-ape-panel" style="margin-bottom: 1rem;">
                <div class="panel-header">
                    ü¶ç Smart Ape
                    <span id="smart-ape-status" style="font-size: 0.75rem; opacity: 0.7;">OFF</span>
                </div>
                <div class="panel-content">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                        Bitcoin Up/Down 15min - Asym√©trique
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <div class="config-group" style="margin-bottom: 0;">
                            <label>Fen√™tre (min)</label>
                            <input type="number" id="smart-ape-window" step="1" value="2" min="1" max="5">
                        </div>
                        <div class="config-group" style="margin-bottom: 0;">
                            <label>Dump Seuil (%)</label>
                            <input type="number" id="smart-ape-dump" step="0.01" value="0.15" min="0.05" max="0.50">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <div class="config-group" style="margin-bottom: 0;">
                            <label>Payout Min</label>
                            <input type="number" id="smart-ape-payout" step="0.1" value="1.5" min="1.0" max="3.0">
                        </div>
                        <div class="config-group" style="margin-bottom: 0;">
                            <label>Ordre ($)</label>
                            <input type="number" id="smart-ape-size" step="5" value="25" min="5" max="100">
                        </div>
                    </div>

                    <div style="font-size: 0.75rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 4px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary);">Positions</span>
                            <span id="smart-ape-positions" class="mono">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary);">P&L</span>
                            <span id="smart-ape-pnl" class="mono" style="color: var(--accent-green);">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Trades</span>
                            <span id="smart-ape-trades" class="mono">0</span>
                        </div>
                    </div>

                    <div class="btn-group" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" id="btn-smart-ape-start" onclick="startSmartApe()"
                            style="flex: 1; justify-content: center;">‚ñ∂ Start</button>
                        <button class="btn btn-danger btn-sm" id="btn-smart-ape-stop" onclick="stopSmartApe()"
                            style="flex: 1; justify-content: center;" disabled>‚èπ Stop</button>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="panel log-panel">
                <div class="panel-header">üìã Logs</div>
                <div class="panel-content" id="activity-log"></div>
            </div>
        </div>

        <!-- Right Content -->

        <!-- Active Trades -->
        <div class="panel active-trades-panel">
            <div class="panel-header">
                ‚ö° Trades Actifs (Scalping En Cours)
                <span class="value-col" id="total-pnl" style="font-size: 0.9rem;">Unrealized: $0.00</span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>March√©</th>
                            <th>Type</th>
                            <th>Entr√©e</th>
                            <th>Actuel</th>
                            <th>P&L</th>
                            <th>Dur√©e</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="trades-tbody">
                        <tr>
                            <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                                Aucun trade actif</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Opportunities -->
        <div class="panel opportunities-panel">
            <div class="panel-header">
                üéØ Scanner Opportunit√©s (> 50 march√©s)
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 30px">Sc.</th>
                            <th>March√©</th>
                            <th>Spread</th>
                            <th>Vol ($)</th>
                            <th>Oui (Bid)</th>
                            <th>Non (Bid)</th>
                            <th style="text-align: right">Trade</th>
                        </tr>
                    </thead>
                    <tbody id="opp-tbody">
                        <tr>
                            <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 4rem;">En
                                attente du scanner...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isRunning = false;

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            fetchStatus();
            fetchBinanceData();
            connectWebSocket();
            setInterval(fetchBinanceData, 10000); // Update Binance every 10s
            setInterval(fetchStatus, 5000); // Check status every 5s
        });

        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                setIsRunning(data.is_running);
                document.getElementById('markets-count').innerText = data.markets_count || 0;
            } catch (e) {
                console.error('Status fetch error:', e);
            }
        }

        function connectWebSocket() {
            try {
                ws = new WebSocket(`ws://${window.location.host}/ws`);
                ws.onopen = () => log('üì° Connect√© au syst√®me', 'var(--accent-green)');
                ws.onmessage = (e) => {
                    try {
                        handleData(JSON.parse(e.data));
                    } catch (err) {
                        console.error('WebSocket message error:', err);
                    }
                };
                ws.onerror = (e) => console.error('WebSocket error:', e);
                ws.onclose = () => {
                    log('üì° Reconnexion...', 'var(--accent-yellow)');
                    setTimeout(connectWebSocket, 3000);
                };
            } catch (e) {
                console.error('WebSocket connect error:', e);
                setTimeout(connectWebSocket, 5000);
            }
        }

        function handleData(msg) {
            if (msg.type === 'update') {
                renderOpportunities(msg.data.opportunities);
                renderTrades(msg.data.active_trades);
                updateStats(msg.data.stats, msg.data.active_trades);
                document.getElementById('markets-count').innerText = msg.data.markets_count;
                // Update Auto-Optimizer UI
                if (msg.data.optimizer) {
                    updateOptimizerUI(msg.data.optimizer);
                }
            } else if (msg.type === 'started') {
                setIsRunning(true);
                log('‚úÖ Scanner HFT D√©marr√©', 'var(--accent-green)');
            } else if (msg.type === 'stopped') {
                setIsRunning(false);
                log('üõë Scanner Arr√™t√©', 'var(--accent-red)');
            } else if (msg.type === 'trades_update') {
                renderTrades(msg.data.active);
                updateStats(msg.data.stats, msg.data.active);
            }
        }

        // --- Render Functions ---

        function renderOpportunities(opps) {
            const tbody = document.getElementById('opp-tbody');
            if (!opps || opps.length === 0) return;

            tbody.innerHTML = opps.map(op => `
                <tr>
                    <td>${'‚≠ê'.repeat(op.score)}</td>
                    <td class="market-col" title="${op.question}">${op.market}</td>
                    <td class="value-col" style="color: var(--accent-green); font-weight: bold;">$${op.spread.toFixed(3)}</td>
                    <td class="value-col">${formatNum(op.volume)}</td>
                    <td class="value-col">$${op.price_yes.toFixed(2)}</td>
                    <td class="value-col">$${op.price_no.toFixed(2)}</td>
                    <td style="text-align: right; white-space: nowrap;">
                        <button class="trade-btn yes" onclick="enterTrade('${op.market_id}', '${op.question.replace(/'/g, "\\'")}', 'yes', ${op.price_yes}, 50)">Buy YES</button>
                        <button class="trade-btn no" onclick="enterTrade('${op.market_id}', '${op.question.replace(/'/g, "\\'")}', 'no', ${op.price_no}, 50)">Buy NO</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderTrades(trades) {
            const tbody = document.getElementById('trades-tbody');
            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Aucun trade actif</td></tr>';
                document.getElementById('total-pnl').innerText = 'Unrealized: $0.00';
                return;
            }

            let totalPnl = 0;
            tbody.innerHTML = trades.map(t => {
                totalPnl += t.unrealized_pnl;
                const pnlClass = t.unrealized_pnl >= 0 ? 'profit-pos' : 'profit-neg';
                return `
                <tr>
                    <td class="market-col" title="${t.market_question}">${t.market_question}</td>
                    <td class="value-col" style="text-transform: uppercase; color: ${t.side === 'yes' ? 'var(--accent-green)' : 'var(--accent-red)'}">${t.side}</td>
                    <td class="value-col">$${t.entry_price.toFixed(3)}</td>
                    <td class="value-col">$${t.current_price.toFixed(3)}</td>
                    <td class="value-col ${pnlClass}">$${t.unrealized_pnl.toFixed(2)} (${t.pnl_percent.toFixed(1)}%)</td>
                    <td class="value-col">${t.duration_seconds}s</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="exitTrade('${t.id}', ${t.current_price})">SORTIR</button>
                    </td>
                </tr>
            `}).join('');

            const totalClass = totalPnl >= 0 ? 'profit-pos' : 'profit-neg';
            document.getElementById('total-pnl').innerHTML = `Unrealized: <span class="${totalClass}">$${totalPnl.toFixed(2)}</span>`;
        }

        // --- Actions ---

        async function enterTrade(marketId, question, side, price, size) {
            if (!confirm(`Confirmer achat ${size} shares de ${side.toUpperCase()} @ $${price} ?`)) return;

            try {
                const res = await fetch('/api/trades/enter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        market_id: marketId,
                        market_question: question,
                        side: side,
                        entry_price: price,
                        size: size
                    })
                });
                const data = await res.json();
                if (data.success) log(`‚úÖ Trade entr√©: ${side.toUpperCase()} @ $${price}`, 'var(--accent-green)');
                else log(`‚ùå Erreur trade: ${data.message}`, 'var(--accent-red)');
            } catch (e) { log(`‚ùå ${e.message}`, 'var(--accent-red)'); }
        }

        async function exitTrade(tradeId, price) {
            if (!confirm(`Confirmer fermeture @ $${price} ?`)) return;

            try {
                const res = await fetch(`/api/trades/${tradeId}/exit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exit_price: price })
                });
                const data = await res.json();
                if (data.success) log(`üö™ Trade ferm√© @ $${price}`, 'var(--accent-yellow)');
                else log(`‚ùå Erreur: ${data.message}`, 'var(--accent-red)');
            } catch (e) { log(`‚ùå ${e.message}`, 'var(--accent-red)'); }
        }

        async function fetchBinanceData() {
            try {
                const res = await fetch('/api/binance');
                const data = await res.json();
                const ticker = document.getElementById('binance-ticker');
                if (data.length > 0) {
                    const items = data.slice(0, 10).map(([asset, vol]) =>
                        `<span class="ticker-item"><span style="color: var(--accent-blue)">${asset.replace('USDT', '')}</span> Vol:${vol.toFixed(1)}%</span>`
                    ).join('');
                    ticker.innerHTML = items + items; // Duplicate for smooth scroll
                }
            } catch (e) { }
        }

        // --- Config & Controls ---

        // Track config changes
        let configDirty = false;
        let originalConfig = {};

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'toast-out 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateApplyButton() {
            const btn = document.getElementById('btn-apply-config');
            if (!btn) return;

            if (configDirty) {
                btn.classList.add('btn-config-dirty');
                btn.innerHTML = '‚ö†Ô∏è Appliquer les changements';
            } else {
                btn.classList.remove('btn-config-dirty');
                btn.innerHTML = 'üíæ Appliquer';
            }
        }

        function setupConfigListeners() {
            // Liste des inputs de config √† surveiller
            const configInputs = [
                'cfg-spread', 'cfg-volume', 'cfg-duration', 'cfg-capital',
                'cfg-auto-trading', 'cfg-kelly-enable', 'cfg-kelly-min', 'cfg-kelly-max'
            ];

            configInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', () => {
                        configDirty = true;
                        updateApplyButton();
                    });
                    input.addEventListener('input', () => {
                        configDirty = true;
                        updateApplyButton();
                    });
                }
            });
        }

        async function loadConfig() {
            const res = await fetch('/api/config');
            const data = await res.json();

            // Store original values
            originalConfig = { ...data };

            document.getElementById('cfg-spread').value = data.min_spread;
            document.getElementById('cfg-volume').value = data.min_volume;
            document.getElementById('cfg-duration').value = data.max_duration_hours;
            document.getElementById('cfg-capital').value = data.capital_per_trade;

            // Auto Trading
            document.getElementById('cfg-auto-trading').checked = data.auto_trading_enabled !== false;

            // Kelly Settings
            document.getElementById('cfg-kelly-enable').checked = data.enable_kelly_sizing || false;
            document.getElementById('cfg-kelly-min').value = data.kelly_min_bet || 5.0;
            document.getElementById('cfg-kelly-max').value = data.kelly_max_bet || 50.0;

            // Reset dirty state after loading
            configDirty = false;
            updateApplyButton();

            // Setup listeners after first load
            setupConfigListeners();
        }

        async function saveConfig() {
            const config = {
                min_spread: parseFloat(document.getElementById('cfg-spread').value),
                min_volume: parseFloat(document.getElementById('cfg-volume').value),
                max_duration_hours: parseInt(document.getElementById('cfg-duration').value),
                capital_per_trade: parseFloat(document.getElementById('cfg-capital').value),
                max_open_positions: 5,

                // Auto Trading
                auto_trading_enabled: document.getElementById('cfg-auto-trading').checked,

                // Kelly Settings
                enable_kelly_sizing: document.getElementById('cfg-kelly-enable').checked,
                kelly_min_bet: parseFloat(document.getElementById('cfg-kelly-min').value),
                kelly_max_bet: parseFloat(document.getElementById('cfg-kelly-max').value)
            };

            try {
                await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(config) });

                // Reset dirty state
                configDirty = false;
                originalConfig = { ...config };
                updateApplyButton();

                // Show success toast
                showToast('Configuration appliquee au Scanner/Gabagool!', 'success');
                log('üíæ Config appliqu√©e', 'var(--accent-green)');
            } catch (e) {
                showToast('Erreur: ' + e.message, 'warning');
                log('‚ùå Erreur config: ' + e.message, 'var(--accent-red)');
            }
        }

        async function startBot() {
            try {
                const res = await fetch('/api/start', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    log('‚úÖ Commande Start envoy√©e', 'var(--accent-green)');
                } else {
                    log(`‚ùå Erreur Start: ${data.message}`, 'var(--accent-red)');
                }
            } catch (e) {
                log(`‚ùå Erreur connexion: ${e.message}`, 'var(--accent-red)');
            }
        }

        async function stopBot() {
            try {
                const res = await fetch('/api/stop', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    log('üõë Commande Stop envoy√©e', 'var(--accent-yellow)');
                } else {
                    log(`‚ùå Erreur Stop: ${data.message}`, 'var(--accent-red)');
                }
            } catch (e) {
                log(`‚ùå Erreur connexion: ${e.message}`, 'var(--accent-red)');
            }
        }

        function setIsRunning(running) {
            document.getElementById('status-dot').className = `status-dot ${running ? 'active' : ''}`;
            document.getElementById('status-text').innerText = running ? 'Actif' : 'Arr√™t√©';
            document.getElementById('btn-start').disabled = running;
            document.getElementById('btn-stop').disabled = !running;
        }

        function updateStats(stats, activeTrades) {
            if (!stats) return;
            document.getElementById('stat-trades').innerText = stats.total_trades || 0;
            document.getElementById('stat-winrate').innerText = `${stats.win_rate || 0}%`;
            document.getElementById('stat-pnl').innerText = `$${(stats.realized_pnl || 0).toFixed(2)}`;
            const activeCount = activeTrades ? activeTrades.length : 0;
            document.getElementById('stat-positions').innerText = `${activeCount}/5`;
        }

        function log(msg, color) {
            const div = document.getElementById('activity-log');
            const time = new Date().toLocaleTimeString();
            div.innerHTML = `<div class="log-entry" style="color: ${color}"><span style="opacity:0.5">[${time}]</span> ${msg}</div>` + div.innerHTML;
        }

        function formatNum(n) {
            if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(1) + 'k';
            return n.toFixed(0);
        }

        // --- Auto-Optimizer Functions ---

        async function startOptimizer() {
            try {
                // Set mode first
                const mode = document.getElementById('optimizer-mode').value;
                await fetch('/api/optimizer/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: mode })
                });

                const res = await fetch('/api/optimizer/start', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    log('üß† Auto-Optimizer d√©marr√©', 'var(--accent-purple)');
                    setOptimizerRunning(true);
                } else {
                    log(`‚ùå Optimizer: ${data.message}`, 'var(--accent-red)');
                }
            } catch (e) {
                log(`‚ùå Erreur Optimizer: ${e.message}`, 'var(--accent-red)');
            }
        }

        async function stopOptimizer() {
            try {
                const res = await fetch('/api/optimizer/stop', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    log('üß† Auto-Optimizer arr√™t√©', 'var(--accent-yellow)');
                    setOptimizerRunning(false);
                }
            } catch (e) {
                log(`‚ùå Erreur: ${e.message}`, 'var(--accent-red)');
            }
        }

        function setOptimizerRunning(running) {
            document.getElementById('optimizer-status').innerText = running ? 'ON' : 'OFF';
            document.getElementById('optimizer-status').style.color = running ? 'var(--accent-green)' : '';
            document.getElementById('btn-optimizer-start').disabled = running;
            document.getElementById('btn-optimizer-stop').disabled = !running;
        }

        function updateOptimizerUI(optimizer) {
            if (!optimizer || !optimizer.running) {
                setOptimizerRunning(false);
                return;
            }

            setOptimizerRunning(optimizer.running);

            // Update params
            if (optimizer.current_params) {
                const p = optimizer.current_params;
                document.getElementById('opt-max-pair-cost').innerText = (p.max_pair_cost || 0.98).toFixed(3);
                document.getElementById('opt-order-size').innerText = '$' + (p.order_size_usd || 25).toFixed(0);
                document.getElementById('opt-first-buy').innerText = (p.first_buy_threshold || 0.55).toFixed(3);
            }

            // Update adjustments count
            document.getElementById('opt-adjustments').innerText = optimizer.total_adjustments || 0;

            // Update conditions
            if (optimizer.conditions) {
                const c = optimizer.conditions;
                document.getElementById('opt-cond-spread').innerText = (c.avg_spread || 0).toFixed(4);
                document.getElementById('opt-cond-vol').innerText = (c.volatility_score || 0).toFixed(1);
            }

            // Update mode dropdown
            if (optimizer.mode) {
                document.getElementById('optimizer-mode').value = optimizer.mode;
            }
        }

        // Handle optimizer mode change
        document.getElementById('optimizer-mode').addEventListener('change', async (e) => {
            try {
                const res = await fetch('/api/optimizer/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: e.target.value })
                });
                const data = await res.json();
                if (data.success) {
                    log(`üß† Mode: ${e.target.value}`, 'var(--accent-purple)');
                }
            } catch (err) {
                console.error('Mode change error:', err);
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SMART APE & STRATEGY MODE FUNCTIONS (v7.0)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const strategyDescriptions = {
            'gabagool': 'Arbitrage YES+NO < $1.00 - March√©s crypto court terme',
            'smart_ape': 'Bitcoin Up/Down 15min - Positions asym√©triques',
            'both': 'Gabagool + Smart Ape simultan√©ment'
        };

        // Handle strategy mode change
        document.getElementById('strategy-mode').addEventListener('change', async (e) => {
            const mode = e.target.value;
            try {
                const res = await fetch('/api/strategy/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: mode })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('strategy-desc').innerText = strategyDescriptions[mode];
                    log(`üéØ Strat√©gie: ${mode}`, 'var(--accent-blue)');
                    showToast(`Strat√©gie chang√©e: ${mode}`, 'success');
                }
            } catch (err) {
                console.error('Strategy mode change error:', err);
                log(`‚ùå Erreur changement strat√©gie`, 'var(--accent-red)');
            }
        });

        // Smart Ape Start
        async function startSmartApe() {
            try {
                // Update config first
                await updateSmartApeConfig();

                const res = await fetch('/api/smart-ape/start', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    log('ü¶ç Smart Ape d√©marr√©', 'var(--accent-green)');
                    setSmartApeRunning(true);
                    showToast('Smart Ape activ√©!', 'success');
                } else {
                    log(`‚ùå Smart Ape: ${data.message}`, 'var(--accent-red)');
                }
            } catch (e) {
                log(`‚ùå Erreur Smart Ape: ${e.message}`, 'var(--accent-red)');
            }
        }

        // Smart Ape Stop
        async function stopSmartApe() {
            try {
                const res = await fetch('/api/smart-ape/stop', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    log('ü¶ç Smart Ape arr√™t√©', 'var(--accent-yellow)');
                    setSmartApeRunning(false);
                }
            } catch (e) {
                log(`‚ùå Erreur: ${e.message}`, 'var(--accent-red)');
            }
        }

        // Update Smart Ape config
        async function updateSmartApeConfig() {
            const config = {
                window_minutes: parseInt(document.getElementById('smart-ape-window').value),
                dump_threshold: parseFloat(document.getElementById('smart-ape-dump').value),
                min_payout_ratio: parseFloat(document.getElementById('smart-ape-payout').value),
                order_size_usd: parseFloat(document.getElementById('smart-ape-size').value),
                max_position_usd: 200.0
            };
            try {
                await fetch('/api/smart-ape/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
            } catch (e) {
                console.error('Smart Ape config error:', e);
            }
        }

        // Set Smart Ape running state
        function setSmartApeRunning(running) {
            document.getElementById('smart-ape-status').innerText = running ? 'ON' : 'OFF';
            document.getElementById('smart-ape-status').style.color = running ? 'var(--accent-green)' : '';
            document.getElementById('btn-smart-ape-start').disabled = running;
            document.getElementById('btn-smart-ape-stop').disabled = !running;
        }

        // Update Smart Ape UI from WebSocket data
        function updateSmartApeUI(data) {
            if (!data) return;

            setSmartApeRunning(data.is_running);

            if (data.stats) {
                document.getElementById('smart-ape-positions').innerText = data.stats.active_positions || 0;
                const pnl = data.stats.total_pnl || 0;
                const pnlEl = document.getElementById('smart-ape-pnl');
                pnlEl.innerText = `$${pnl.toFixed(2)}`;
                pnlEl.style.color = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                document.getElementById('smart-ape-trades').innerText = data.stats.total_trades || 0;
            }
        }

        // Fetch Smart Ape status on load
        async function fetchSmartApeStatus() {
            try {
                const res = await fetch('/api/smart-ape/status');
                const data = await res.json();
                updateSmartApeUI(data);
            } catch (e) {
                console.error('Smart Ape status error:', e);
            }
        }

        // Fetch strategy mode on load
        async function fetchStrategyMode() {
            try {
                const res = await fetch('/api/strategy/mode');
                const data = await res.json();
                if (data.mode) {
                    document.getElementById('strategy-mode').value = data.mode;
                    document.getElementById('strategy-desc').innerText = strategyDescriptions[data.mode];
                }
            } catch (e) {
                console.error('Strategy mode fetch error:', e);
            }
        }

        // Add to init
        document.addEventListener('DOMContentLoaded', () => {
            fetchSmartApeStatus();
            fetchStrategyMode();
            fetchCapitalConfig();
            setupCapitalListeners();
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CAPITAL MANAGEMENT FUNCTIONS (v7.1)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Update trade size display based on capital and percent
        function updateTradeSizeDisplay() {
            const gabagoolCapital = parseFloat(document.getElementById('gabagool-capital').value) || 500;
            const gabagoolPercent = parseFloat(document.getElementById('gabagool-percent').value) || 5;
            const gabagoolTradeSize = (gabagoolCapital * gabagoolPercent) / 100;
            document.getElementById('gabagool-trade-size').innerText = `$${gabagoolTradeSize.toFixed(2)}`;

            const smartApeCapital = parseFloat(document.getElementById('smart-ape-capital').value) || 300;
            const smartApePercent = parseFloat(document.getElementById('smart-ape-percent').value) || 8;
            const smartApeTradeSize = (smartApeCapital * smartApePercent) / 100;
            document.getElementById('smart-ape-trade-size').innerText = `$${smartApeTradeSize.toFixed(2)}`;
        }

        // Setup listeners for capital inputs
        function setupCapitalListeners() {
            const inputs = ['gabagool-capital', 'gabagool-percent', 'smart-ape-capital', 'smart-ape-percent'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updateTradeSizeDisplay);
                    el.addEventListener('change', updateTradeSizeDisplay);
                }
            });
        }

        // Save capital configuration
        async function saveCapitalConfig() {
            const config = {
                gabagool_capital_usd: parseFloat(document.getElementById('gabagool-capital').value),
                gabagool_trade_percent: parseFloat(document.getElementById('gabagool-percent').value),
                smart_ape_capital_usd: parseFloat(document.getElementById('smart-ape-capital').value),
                smart_ape_trade_percent: parseFloat(document.getElementById('smart-ape-percent').value)
            };

            try {
                const res = await fetch('/api/capital/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Capital sauvegard√©!', 'success');
                    log(`üí∞ Capital: Gabagool $${config.gabagool_capital_usd} (${config.gabagool_trade_percent}%), Smart Ape $${config.smart_ape_capital_usd} (${config.smart_ape_trade_percent}%)`, 'var(--accent-blue)');
                } else {
                    showToast('Erreur: ' + data.message, 'warning');
                }
            } catch (e) {
                log(`‚ùå Erreur capital: ${e.message}`, 'var(--accent-red)');
            }
        }

        // Fetch capital configuration on load
        async function fetchCapitalConfig() {
            try {
                const res = await fetch('/api/capital/config');
                const data = await res.json();
                if (data) {
                    document.getElementById('gabagool-capital').value = data.gabagool_capital_usd || 500;
                    document.getElementById('gabagool-percent').value = data.gabagool_trade_percent || 5;
                    document.getElementById('smart-ape-capital').value = data.smart_ape_capital_usd || 300;
                    document.getElementById('smart-ape-percent').value = data.smart_ape_trade_percent || 8;
                    updateTradeSizeDisplay();
                }
            } catch (e) {
                console.error('Capital config fetch error:', e);
                updateTradeSizeDisplay(); // Use defaults
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // KELLY SIZING FUNCTIONS (v7.2)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Save Kelly configuration
        async function saveKellyConfig() {
            const config = {
                kelly_enabled_gabagool: document.getElementById('kelly-gabagool').checked,
                kelly_enabled_smart_ape: document.getElementById('kelly-smart-ape').checked,
                kelly_fraction: parseFloat(document.getElementById('kelly-fraction').value),
                kelly_max_size_multiplier: parseFloat(document.getElementById('kelly-max-multi').value)
            };

            try {
                const res = await fetch('/api/kelly/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await res.json();
                if (data.success) {
                    log(`üìä Kelly: Gabagool=${config.kelly_enabled_gabagool}, SmartApe=${config.kelly_enabled_smart_ape}, Fraction=${config.kelly_fraction}`, 'var(--accent-purple)');
                }
            } catch (e) {
                console.error('Kelly config error:', e);
            }
        }

        // Fetch Kelly configuration on load
        async function fetchKellyConfig() {
            try {
                const res = await fetch('/api/kelly/config');
                const data = await res.json();
                if (data) {
                    document.getElementById('kelly-gabagool').checked = data.kelly_enabled_gabagool || false;
                    document.getElementById('kelly-smart-ape').checked = data.kelly_enabled_smart_ape || false;
                    document.getElementById('kelly-fraction').value = data.kelly_fraction || 0.25;
                    document.getElementById('kelly-max-multi').value = data.kelly_max_size_multiplier || 2.0;
                }
            } catch (e) {
                console.error('Kelly config fetch error:', e);
            }
        }

        // Fetch Kelly stats
        async function fetchKellyStats() {
            try {
                const res = await fetch('/api/kelly/status');
                const data = await res.json();
                if (data && !data.error) {
                    // Update win rates
                    if (data.gabagool) {
                        const wr = data.gabagool.win_rate || 0;
                        document.getElementById('kelly-winrate-gabagool').innerText = `${(wr * 100).toFixed(1)}%`;
                    }
                    if (data.smart_ape) {
                        const wr = data.smart_ape.win_rate || 0;
                        document.getElementById('kelly-winrate-smartape').innerText = `${(wr * 100).toFixed(1)}%`;
                    }
                    // Update trade counts
                    const totalTrades = (data.trade_counts?.gabagool || 0) + (data.trade_counts?.smart_ape || 0);
                    document.getElementById('kelly-trades').innerText = totalTrades;
                }
            } catch (e) {
                console.error('Kelly stats error:', e);
            }
        }

        // Add Kelly to init
        const originalDOMContentLoaded = document.addEventListener;
        document.addEventListener('DOMContentLoaded', () => {
            fetchKellyConfig();
            fetchKellyStats();
            // Refresh Kelly stats every 30 seconds
            setInterval(fetchKellyStats, 30000);
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PAPER TRADING (v8.2)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let paperEnabled = false;

        async function fetchPaperStatus() {
            try {
                const res = await fetch('/api/paper/status');
                const data = await res.json();

                paperEnabled = data.enabled;

                // Update toggle button
                const btn = document.getElementById('btn-paper-toggle');
                const badge = document.getElementById('paper-status-badge');

                if (data.enabled) {
                    btn.innerText = 'ON';
                    btn.className = 'btn btn-sm btn-success';
                    badge.innerText = 'ON';
                    badge.style.background = '#16a34a';
                } else {
                    btn.innerText = 'OFF';
                    btn.className = 'btn btn-sm btn-danger';
                    badge.innerText = 'OFF';
                    badge.style.background = '#dc2626';
                }

                // Update config fields
                document.getElementById('paper-capital').value = data.capital || 500;
                document.getElementById('paper-strategy-mode').value = data.strategy_mode || 'both';

                // Update stats
                document.getElementById('paper-balance').innerText = `$${(data.balance || 0).toFixed(2)}`;

                const pnl = data.realized_pnl || 0;
                const pnlEl = document.getElementById('paper-pnl');
                pnlEl.innerText = `$${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}`;
                pnlEl.style.color = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

                document.getElementById('paper-trades-count').innerText = data.trades_count || 0;

                // Update optimized params preview
                updateOptimizedPreview(data.capital, data.strategy_mode);

            } catch (e) {
                console.error('Paper status error:', e);
            }
        }

        async function togglePaperMode() {
            try {
                const res = await fetch('/api/paper/toggle', { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    showToast(data.message, data.enabled ? 'success' : 'warning');
                    fetchPaperStatus();
                }
            } catch (e) {
                console.error('Toggle paper error:', e);
            }
        }

        async function applyPaperConfig() {
            const capital = parseFloat(document.getElementById('paper-capital').value) || 500;
            const strategyMode = document.getElementById('paper-strategy-mode').value;

            try {
                const res = await fetch('/api/paper/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ capital, strategy_mode: strategyMode })
                });
                const data = await res.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    fetchPaperStatus();
                } else {
                    showToast('Erreur: ' + data.error, 'warning');
                }
            } catch (e) {
                console.error('Apply paper config error:', e);
            }
        }

        async function resetPaperTrading() {
            if (!confirm('Voulez-vous vraiment remettre √† z√©ro le paper trading? Toutes les stats seront effac√©es.')) {
                return;
            }

            try {
                const res = await fetch('/api/paper/reset', { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    fetchPaperStatus();
                }
            } catch (e) {
                console.error('Reset paper error:', e);
            }
        }

        async function updateOptimizedPreview(capital, strategyMode) {
            try {
                const res = await fetch(`/api/paper/optimized-params?capital=${capital}&strategy_mode=${strategyMode}`);
                const data = await res.json();

                if (data.error) {
                    document.getElementById('paper-optimized-preview').style.display = 'none';
                    return;
                }

                document.getElementById('paper-optimized-preview').style.display = 'block';
                document.getElementById('paper-tier').innerText = `TIER: ${data.tier.toUpperCase()}`;

                if (data.gabagool) {
                    document.getElementById('paper-gab-trade').innerText = `$${data.gabagool.trade_size.toFixed(2)}`;
                    document.getElementById('paper-gab-pos').innerText = data.gabagool.max_positions;
                }

                if (data.smart_ape) {
                    document.getElementById('paper-ape-trade').innerText = `$${data.smart_ape.trade_size.toFixed(2)}`;
                    document.getElementById('paper-ape-pos').innerText = data.smart_ape.max_positions;
                }

                if (data.risk) {
                    document.getElementById('paper-daily-limit').innerText = `$${data.risk.daily_loss_limit.toFixed(0)}`;
                }
            } catch (e) {
                console.error('Optimized params error:', e);
            }
        }

        // Update preview when capital or mode changes
        document.getElementById('paper-capital').addEventListener('change', () => {
            const capital = parseFloat(document.getElementById('paper-capital').value) || 500;
            const mode = document.getElementById('paper-strategy-mode').value;
            updateOptimizedPreview(capital, mode);
        });

        document.getElementById('paper-strategy-mode').addEventListener('change', () => {
            const capital = parseFloat(document.getElementById('paper-capital').value) || 500;
            const mode = document.getElementById('paper-strategy-mode').value;
            updateOptimizedPreview(capital, mode);
        });

        // Init paper trading on load
        document.addEventListener('DOMContentLoaded', () => {
            fetchPaperStatus();
            // Refresh every 10 seconds
            setInterval(fetchPaperStatus, 10000);
        });
    </script>
</body>

</html>